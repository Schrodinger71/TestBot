name: Start Discord Test

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Load Environment Variables
        run: |
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" >> $GITHUB_ENV
          echo "GIT_PAT_TOKEN=${{ secrets.GIT_PAT_TOKEN }}" >> $GITHUB_ENV

      - name: Install localtunnel
        run: npm install -g localtunnel

      - name: Run bot and expose with localtunnel
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        run: |
          echo "Starting the bot..."
          nohup python main.py > bot.log 2>&1 &

          # –ñ–¥—ë–º, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
          sleep 5

          # –ó–∞–ø—É—Å–∫–∞–µ–º localtunnel –∏ –≤—ã–≤–æ–¥–∏–º URL
          lt --port 8000 --print-requests > tunnel.log &
          sleep 5

          echo "====================================="
          echo "üîó –°–°–´–õ–ö–ê –ù–ê WEB-–ò–ù–¢–ï–†–§–ï–ô–°:"
          grep -Eo 'https://[^[:space:]]+' tunnel.log || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É"
          echo "====================================="

      - name: Keep alive (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª—Å—è)
        run: |
          echo "‚è≥ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º workflow –∞–∫—Ç–∏–≤–Ω—ã–º..."
          tail -f /dev/null
